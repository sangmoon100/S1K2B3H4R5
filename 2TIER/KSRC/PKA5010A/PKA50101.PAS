unit PKA50101;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  ComCtrls, StdCtrls, Mask, ExtCtrls, Buttons, numedit, Grids, DBGrids, Fempno,
  DBTables, Db, codelib, Calen1, MemDS, DBAccess, Ora, OraError, Math, Func, KeyEmpno,
  KeyEmpnoY, ImgList, Pass, OraSmart, OnSkinBtn, OnEditBtnCtrl, KeyCode, Comobj,
  OnEditCombo, OnEditStdCtrl, OnEditBaseCtrl, OnEditNumCtl, OnPopupEdit,
  OnGrDBGrid, OnScheme, OnPersonEdit, Formmon1, OnRadioBtn;
  //timeftp,Datelib,pass, codeText,ImgList,jpeg,

type
  TMainForm = class(TForm)
    DataSource: TDataSource;
    Panel10: TPanel;
    BBinsert: TBitBtn;
    BBdelete: TBitBtn;
    BBsave: TBitBtn;
    BBcancel: TBitBtn;
    BBexit: TBitBtn;
    P_Help: TPanel;
    OraQuery: TOraQuery;
    tmp_oraqry: TOraQuery;
    Notebook1: TNotebook;
    Panel187: TPanel;
    SB_2: TOnSkinButton;
    SB_1: TOnSkinButton;
    Panel11: TPanel;
    SB_3: TOnSkinButton;
    Panel12: TPanel;
    OnGrDbGrid2: TOnGrDbGrid;
    OnGrDbGrid3: TOnGrDbGrid;
    e_botyymm: TOnEdit;
    e_botdate: TOnEdit;
    e_workemp1: TOnEdit;
    e_workemp2: TOnEdit;
    BBexcel: TBitBtn;
    SF_Main: TOnSchemeForm;
    L_UserName: TLabel;
    L_CurDate: TLabel;
    E_empno: TOnWinPopupEdit;
    E_conempno: TOnPersonPopupEdit;
    E_botyymm1: TOnMaskEdit;
    Panel1: TPanel;
    R_conyn1: TOnRadioButton;
    R_conN1: TOnRadioButton;
    R_conY1: TOnRadioButton;
    R_con1: TOnRadioButton;
    SB_4: TOnSkinButton;
    Panel2: TPanel;
    OnGrDbGrid4: TOnGrDbGrid;
    E_BOTYYMM2: TOnMaskEdit;
    Panel3: TPanel;
    R_conyn2: TOnRadioButton;
    R_conN2: TOnRadioButton;
    R_conY2: TOnRadioButton;
    R_con2: TOnRadioButton;
    BBmail: TBitBtn;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure BBexitClick(Sender: TObject);
    procedure DataSourceDataChange(Sender: TObject; Field: TField);
    procedure BBcancelClick(Sender: TObject);
    procedure BBdeleteClick(Sender: TObject);
    procedure BBinsertClick(Sender: TObject);
    procedure BBsaveClick(Sender: TObject);
    procedure SB_1Click(Sender: TObject);
    procedure BBexcelClick(Sender: TObject);
    procedure E_empnoInitPopup(Sender: TObject);
    procedure E_empnoCloseUp(Sender: TObject; var Text: String;
      var Accept: Boolean);
    procedure E_botyymm1Click(Sender: TObject);
    procedure R_conyn1Click(Sender: TObject);
    procedure BBmailClick(Sender: TObject);
  private
    { Private declarations }
    SendProgID, SendEmpno, RcveEmpno, MailSubject, MailBody, ReceiveYN : String;
    function  Send_WebHint(SendProgID, SendEmpno, RcveEmpno, MailSubject, MailBody, ReceiveYN : String) : Boolean; //2007.08.01.dsa2000
  public
    Vempno      : String;
    procedure clear_fields;
    procedure open_grid;
    procedure delete_record;
    procedure insert_record;
    procedure update_record;
    { Public declarations }


  end;

var
  MainForm    : TMainForm;
  WorkMode    : Integer;


implementation

uses PKA50102;

{$R *.DFM}

procedure TMainForm.clear_fields;
begin
  if Notebook1.ActivePage = 'P2' then
  begin
       E_empno.text       := '';
       E_conempno.text    := '';
  end;
end;

procedure TMainForm.open_grid;
begin
  if Notebook1.ActivePage = 'P1' then
  begin
       with OraQuery do
       begin
            Close;
            Sql.Clear;
            Sql.Add(' SELECT BOTYYMM, BOTDATE, WORKEMP1, WORKEMP2  ');
            Sql.Add('   FROM PKBOTBAS                              ');
            Open;
       end;
  end
  else if Notebook1.ActivePage = 'P2' then
  begin
       with OraQuery do
       begin
            Close;
            Sql.Clear;
            Sql.Add(' SELECT EMPNO,                                                         ');
            Sql.Add('       (select KORNAME from pimpmas where empno=a.empno)    KORNAME,   ');
            Sql.Add('       (select DEPTNAME from pycdept                                   ');
            Sql.Add('         where (orgnum,deptcode)                                       ');
            Sql.Add('             = (select orgnum,deptcode from pimpmas                    ');
            Sql.Add('                 where empno=a.empno)) DEPTNAME,                       ');
            Sql.Add('        CONEMPNO,                                                      ');
            Sql.Add('       (select KORNAME from pimpmas where empno=a.conempno) CONKORNAME ');
            Sql.Add('   FROM PKBOTEMP a                                                     ');
            Sql.Add('  ORDER BY EMPNO                                                       ');
            Open;

            fieldbyname('EMPNO'     ).Alignment := taCenter;
            fieldbyname('KORNAME'   ).Alignment := taCenter;
            fieldbyname('CONEMPNO'  ).Alignment := taCenter;
            fieldbyname('CONKORNAME').Alignment := taCenter;
       end;
  end
  else if Notebook1.ActivePage = 'P3' then
  begin
       with OraQuery do
       begin
            Close;
            Sql.Clear;
            Sql.add('Select substr(Workdate,1,6) BOTYYMM,  empno,                                  ');
            Sql.add('      (Select Korname from pimpmas where empno =a.empno) KORNAME,             ');
            Sql.add('      (Select orgnum  from pimpmas where empno =a.empno) ORGNUM,              ');
            Sql.add('      (Select deptcode from pimpmas where empno =a.empno) DEPTCODE,           ');
            Sql.add('      (Select deptname from pycdept where (orgnum,deptcode) =                 ');
            Sql.add('                                          (select orgnum,deptcode             ');
            Sql.add('                                             from pimpmas                     ');
            Sql.add('                                            where empno =a.empno)) DEPTNAME,  ');
            Sql.add('      (Select CONEMPNO from PKBOTEMP where empno =a.EMPNO) CONEMPNO,          ');
            Sql.add('      (Select Korname  from pimpmas                                           ');
            Sql.add('        where empno =(Select CONEMPNO from PKBOTEMP                           ');
            Sql.add('                       where empno =a.EMPNO))       CONKORNAME,               ');
            Sql.add('       sum(CALCTIME) CALCTIME, sum(CALCPAY) CALCPAY,                          ');
            Sql.add('       Decode(conyn,''N'',''∫ÒΩ¬¿Œ'',''Y'',''Ω¬¿Œ'',''πÃ∞·¿Á'') CONYN         ');
            Sql.add('  From PKBOTHIS a                                                             ');
            Sql.add(' Where Workdate like '''+ Trim(E_botyymm1.Text)  + '''||''%''                 ');
            if      R_conYN1.Checked then
            Sql.add('   And Conyn   is  NULL                                                       ')
            else if R_conN1.Checked  then
            Sql.add('   And Conyn   = ''N''                                                        ')
            else if R_conY1.Checked  then
            Sql.add('   And Conyn   = ''Y''                                                        ');
            Sql.add(' Group By substr(Workdate,1,6),empno,CONYN                                    ');
            Sql.add(' order By empno,CONEMPNO                                                      ');
            Open;

            fieldbyname('BOTYYMM'   ).Alignment := taCenter;
            fieldbyname('EMPNO'     ).Alignment := taCenter;
            fieldbyname('KORNAME'   ).Alignment := taCenter;
            fieldbyname('ORGNUM'    ).Alignment := taCenter;
            fieldbyname('DEPTCODE'  ).Alignment := taCenter;
            fieldbyname('CONEMPNO'  ).Alignment := taCenter;
            fieldbyname('CONKORNAME').Alignment := taCenter;
            TFloatField(FieldByName('CALCPAY')).DisplayFormat := '#,###';
       end;
  end
  else if Notebook1.ActivePage = 'P4' then
  begin
       with OraQuery do
       begin
            Close;
            Sql.Clear;
            Sql.add('Select empno,                                                                 ');
            Sql.add('      (Select Korname  from pimpmas where empno =a.empno) KORNAME,            ');
            Sql.add('       WORKDATE, TIMEFROM, TIMETO, OTDESC,                                    ');
            Sql.add('       CALCTIME,  CALCPAY,                                                    ');
            Sql.add('       Decode(conyn,''N'',''∫ÒΩ¬¿Œ'',''Y'',''Ω¬¿Œ'',''πÃ∞·¿Á'') CONYN, CONSAYU');
            Sql.add('  From PKBOTHIS a                                                             ');
            Sql.add(' Where Workdate like '''+ Trim(E_botyymm2.Text)  + '''||''%''                 ');
            if      R_conYN2.Checked then
            Sql.add('   And Conyn   is  NULL                                                       ')
            else if R_conN2.Checked  then
            Sql.add('   And Conyn   = ''N''                                                        ')
            else if R_conY2.Checked  then
            Sql.add('   And Conyn   = ''Y''                                                        ');
            Sql.add(' order By empno,Workdate                                                      ');
            Open;

            fieldbyname('EMPNO'    ).Alignment := taCenter;
            fieldbyname('KORNAME'  ).Alignment := taCenter;
            fieldbyname('WORKDATE' ).Alignment := taCenter;
            fieldbyname('TIMEFROM' ).Alignment := taCenter;
            fieldbyname('TIMETO'   ).Alignment := taCenter;
            TFloatField(FieldByName('CALCPAY' )).DisplayFormat := '#,###';
       end;
  end;
end;

procedure TMainForm.delete_record;
begin
  if Notebook1.ActivePage = 'P2' then
  begin
       with tmp_oraqry do
       begin
            Close;
            SQL.Clear;
            SQL.Add('delete from PKBOTEMP                                     ');
            SQL.Add(' where empno = :empno                                    ');

            ParamByName('empno').AsString := E_empno.Hint;
            execsql;
       end;
  end;
end;

procedure TMainForm.insert_record;
begin
  if Notebook1.ActivePage = 'P2' then
  begin
       if trim(E_Empno.text) = '' then
       begin
            MessageBox(handle,'∫Òº≠ºˆ¥Á ¥ÎªÛ¿⁄∏¶ π›µÂΩ√ ¿‘∑¬«œº≈æﬂ «’¥œ¥Ÿ.','¿⁄∑·ø¿∑˘',MB_OK);
            E_empno.SetFocus;
            exit;
       end;

       if trim(E_conEmpno.text) = ''  then
       begin
            MessageBox(handle,'∫Òº≠ºˆ¥Á ∞·¿Á¿⁄∏¶ π›µÂΩ√ ¿‘∑¬«œº≈æﬂ «’¥œ¥Ÿ.','¿⁄∑·ø¿∑˘',MB_OK);
            E_conEmpno.SetFocus;
            exit;
       end;

       with tmp_oraqry do
       begin
            Close;
            Sql.Clear;
            Sql.Add(' INSERT INTO PKBOTEMP ( EMPNO, CONEMPNO, WRITEMAN, WRITETIME) ');
            Sql.Add('               VALUES (:empno,:conempno,:WRITEMAN,:WRITETIME) ');

            ParamByName('empno'     ).AsString := E_empno.Hint;
            ParamByName('conempno'  ).AsString := E_conempno.empno;
            ParamByName('writetime' ).AsString := fn_GetDateTimeStr;
            ParamByName('writeman'  ).AsString := PEmpNo;

            ExecSQL;
       end;
  end;

  P_Help.Caption := '   ªı∑ŒøÓ µ•¿Ã≈Õ∞° ¿‘∑¬µ«æ˙Ω¿¥œ¥Ÿ...';
end;

procedure TMainForm.update_record;
begin
  if NoteBook1.ActivePage = 'P1' then
  begin
       if (trim(e_botyymm.text) = '') or (trim(e_botdate.text) = '') or (trim(e_workemp1.text) = '') then
       begin
            MessageBox(handle,'∫Òº≠ºˆ¥Á µÓ∑œ±‚¡ÿø˘, µÓ∑œ∏∂∞®¿œ, ¥„¥Á¿⁄ªÁπ¯1¿∫ π›µÂΩ√ ¿‘∑¬«œº≈æﬂ «’¥œ¥Ÿ.','¿⁄∑·ø¿∑˘',MB_OK);
            e_botyymm.SetFocus;
            exit;
       end;

       with tmp_oraqry do
       begin
            Close;
            Sql.Clear;
            Sql.Add(' UPDATE PKBOTBAS SET                                      ');
            Sql.Add('     BOTYYMM   = :BOTYYMM,                                ');
            Sql.Add('     BOTDATE   = :BOTDATE,                                ');
            Sql.Add('     WORKEMP1  = :WORKEMP1,                               ');
            Sql.Add('     WORKEMP2  = :WORKEMP2,                               ');
            Sql.Add('     WRITETIME = :writetime,                              ');
            Sql.Add('     WRITEMAN  = :writeman                                ');

            ParamByName('BOTYYMM').AsString     := e_botyymm.Text;
            ParamByName('BOTDATE').AsString     := e_botdate.Text;
            ParamByName('WORKEMP1').AsString    := e_workemp1.Text;
            ParamByName('WORKEMP2').AsString    := e_workemp2.Text;
            ParamByName('WRITETIME').AsString   := fn_GetDateTimeStr;
            ParamByName('WRITEMAN').AsString    := PEmpNo;

            ExecSQL;
       end;
  end
  else if NoteBook1.ActivePage = 'P2' then
  begin
       if trim(E_empno.text) = '' then
       begin
            MessageBox(handle,'∫Òº≠ºˆ¥Á ¥ÎªÛ¿⁄∏¶ π›µÂΩ√ ¿‘∑¬«œº≈æﬂ «’¥œ¥Ÿ.','¿⁄∑·ø¿∑˘',MB_OK);
            E_empno.SetFocus;
            exit;
       end;

       if trim(E_conempno.text) = ''  then
       begin
            MessageBox(handle,'∫Òº≠ºˆ¥Á ∞·¿Á¿⁄∏¶ π›µÂΩ√ ¿‘∑¬«œº≈æﬂ «’¥œ¥Ÿ.','¿⁄∑·ø¿∑˘',MB_OK);
            E_conempno.SetFocus;
            exit;
       end;

       with tmp_oraqry do
       begin
            Close;
            Sql.Clear;
            Sql.Add(' UPDATE PKBOTEMP SET                                      ');
            Sql.Add('        CONEMPNO   = :conempno,                           ');
            Sql.Add('        WRITETIME  = :writetime,                          ');
            Sql.Add('        WRITEMAN   = :writeman                            ');
            SQL.Add('  where EMPNO      = :empno                               ');

            ParamByName('conempno'  ).AsString := E_conempno.empno;
            ParamByName('writetime' ).AsString := fn_GetDateTimeStr;
            ParamByName('writeman'  ).AsString := PEmpNo;

            ParamByName('empno'     ).AsString := E_empno.Hint;

            ExecSQL;
       end;
  end;
end;

procedure TMainForm.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action := CaFree;
end;

procedure TMainForm.FormCreate(Sender: TObject);
begin
  OraConnect;
  Pempno   := PassEmp(cmdline,1);
  Pkorname := PassEmp(cmdline,2);
  Pgrade   := Passemp(cmdline,4);

  Vempno   := Pempno;

  Application.ProcessMessages;

  //∞¸∏Æ¿⁄ ±««— ¿Ãø‹ø°¥¬ ªÁøÎ∫“∞°.
  if (Copy(Pgrade,3,1) > 'C') then
  begin
       MessageBox(handle,'∞¸∏Æ¿⁄ ±««— ø‹ø°¥¬ ø≠∂˜«“ ºˆ æ¯Ω¿¥œ¥Ÿ.','æÀ ∏≤',MB_OK or $0030);
       Close;
  end;

  L_CurDate.Caption  := fn_GetDateStr;
  L_UserName.Caption := Pkorname+'('+PEmpno+')';
  Application.ProcessMessages;

  SB_1Click(SB_1);
end;

procedure TMainForm.BBexitClick(Sender: TObject);
begin
  if MessageBox(handle,'¡æ∑· «œΩ√∞⁄Ω¿¥œ±Ó?','»Æ ¿Œ',MB_YESNO or $0030) = ID_YES then  halt(1);
end;

procedure TMainForm.DataSourceDataChange(Sender: TObject; Field: TField);
begin
  if NoteBook1.ActivePage = 'P1' then
  begin
       if not oraquery.Eof then
       begin
            with oraquery do
            begin
                 e_botyymm.Text  := fieldbyname('BOTYYMM').asstring;
                 e_botdate.Text  := fieldbyname('BOTDATE').asstring;

                 e_workemp1.text := fieldbyname('WORKEMP1').asstring;
                 e_workemp2.text := fieldbyname('WORKEMP2').asstring;

                 e_botyymm1.Text  := fieldbyname('BOTYYMM').asstring;
                 e_botyymm2.Text  := fieldbyname('BOTYYMM').asstring;
            end;

            WorkMode := 2; { update mode }
       end
       else begin
            WorkMode     := 0;
            Clear_Fields;
       end;
  end
  else if NoteBook1.ActivePage = 'P2' then
  begin
       if not oraquery.Eof then
       begin
            with oraquery do
            begin
                 E_empno.Text        := fieldbyname('empno'     ).asstring + ' - ' +
                                        fieldbyname('korname'   ).asstring;
                 E_empno.Hint        := fieldbyname('empno'     ).asstring;

                 E_conempno.Text     := fieldbyname('conempno'  ).asstring + ' - ' +
                                        fieldbyname('conkorname').asstring;
                 E_conempno.empno    := fieldbyname('conempno'  ).asstring;
            end;

            WorkMode := 2; { update mode }

            E_empno.enabled := false;
       end
       else begin
            WorkMode     := 0;
            Clear_Fields;
       end;
  end;
end;

procedure TMainForm.BBcancelClick(Sender: TObject);
begin
  open_grid;
end;

procedure TMainForm.BBdeleteClick(Sender: TObject);
begin
  if WorkMode = 2 then
  begin
       if ( IDYes = Application.MessageBox(' «ˆ¿Á µ•¿Ã≈Õ∏¶ ªË¡¶«œΩ√∞⁄Ω¿¥œ±Ó? ', '»Æ ¿Œ',MB_YESNO ) ) then
       begin
            Delete_Record;
            Open_Grid;
            P_Help.Caption := '';
       end;
  end
  else
       P_Help.Caption := '   µÓ∑œµ» ¿⁄∑·ø° «—«ÿº≠∏∏ ªË¡¶ ¿€æ˜¿ª «œΩ« ºˆ ¿÷Ω¿¥œ¥Ÿ...';
end;

procedure TMainForm.BBinsertClick(Sender: TObject);
begin
  WorkMode := 1;
  Clear_Fields;

  if NoteBook1.ActivePage = 'P2' then
  begin
       E_Empno.enabled    := true;

       E_Empno.SetFocus;
  end;
end;

procedure TMainForm.BBsaveClick(Sender: TObject);
begin
  if WorkMode = 2 then
  begin
       Update_Record;
       Open_Grid;
       System.Exit;
  end;

  if WorkMode = 1 then
  begin
       Insert_Record;
       Open_Grid;
       System.Exit;
  end;

  if WorkMode = 0 then
       P_Help.Caption := '   ¿˙¿Â¿€æ˜¿∫ "¿‘∑¬"ªÛ≈¬≥™ "ºˆ¡§"ªÛ≈¬ø°º≠ ∞°¥…«’¥œ¥Ÿ...';
end;

procedure TMainForm.SB_1Click(Sender: TObject);
begin
  SB_1.BtnDown  := False;
  SB_2.BtnDown  := False;
  SB_3.BtnDown  := False;
  SB_4.BtnDown  := False;

  TOnSkinButton(Sender).BtnDown := True;

  if      TOnSkinButton(Sender).Name = 'SB_1' then
  begin
       BBexcel.Enabled  := False;
       BBmail.Visible   := False;

       BBinsert.Enabled := False;
       BBdelete.Enabled := False;
       BBsave.Enabled   := True;
       BBcancel.Enabled := True;
  end
  else if TOnSkinButton(Sender).Name = 'SB_2' then
  begin
       BBexcel.Enabled  := True;
       BBmail.Visible   := False;

       BBinsert.Enabled := True;
       BBdelete.Enabled := True;
       BBsave.Enabled   := True;
       BBcancel.Enabled := True;
  end
  else if TOnSkinButton(Sender).Name = 'SB_3' then
  begin
       BBexcel.Enabled  := True;
       BBmail.Visible   := True;

       BBinsert.Enabled := False;
       BBdelete.Enabled := False;
       BBsave.Enabled   := False;
       BBcancel.Enabled := False;
  end
  else if TOnSkinButton(Sender).Name = 'SB_4' then
  begin
       BBexcel.Enabled  := True;
       BBmail.Visible   := False;

       BBinsert.Enabled := False;
       BBdelete.Enabled := False;
       BBsave.Enabled   := False;
       BBcancel.Enabled := False;
  end;

  Application.ProcessMessages;
  NoteBook1.ActivePage := 'P' + IntToStr(TOnSkinButton(Sender).Tag);
  open_grid;
end;

procedure TMainForm.BBexcelClick(Sender: TObject);
var XL, XArr   : Variant;
    i, j, k    : integer;
    SavePlace  : TBookmark;
begin
  P_Help.Caption :=' ø¢ºø ∫Ø»Ø«“ ¿⁄∑·∏¶ ∞Àªˆ¡ﬂ¿‘¥œ¥Ÿ.';

  if OraQuery.RecordCount < 1 then
  begin
       P_Help.Caption :='';
       showmessage('ø¢ºø ∫Ø»Ø«“ ¿⁄∑·∞° æ¯Ω¿¥œ¥Ÿ.');
       exit;
  end;
  P_Help.Caption := 'Excel¿Ã º≥ƒ°µ«æÓ ¿÷¥¬¡ˆ ∞Àªˆ«œ∞Ì ¿÷Ω¿¥œ¥Ÿ.';

  XArr := VarArrayCreate([1, OraQuery.Fields.Count], VarVariant); //Gird √‚∑¬Ω√
  try
      XL := CreateOLEObject('Excel.Application');
  except
      MessageDlg('Excel¿Ã º≥ƒ°µ«æÓ ¿÷¡ˆ æ Ω¿¥œ¥Ÿ.', MtWarning, [mbok], 0);
      P_Help.Caption := '';
      Exit;
  end;

  P_Help.Caption := '¿⁄∑·∏¶ ∫Ø»Ø«œ∞Ì ¿÷Ω¿¥œ¥Ÿ.';
  XL.WorkBooks.Add;                                 //ªı∑ŒøÓ ∆‰¿Ã¡ˆ ª˝º∫
  XL.Visible := false;
  if      Notebook1.ActivePage = 'P2' then
       XL.WorkSheets[1].Name := '∫Òº≠ºˆ¥Á ¥ÎªÁ¿⁄'                            //Ω√∆Æ∏Ì ∫Œø©
  else if Notebook1.ActivePage = 'P3' then
       XL.WorkSheets[1].Name := '∞≥¿Œ∫∞ ∫Òº≠ºˆ¥Á «’∞Ë_'+E_botyymm1.Text      //Ω√∆Æ∏Ì ∫Œø©
  else if Notebook1.ActivePage = 'P4' then
       XL.WorkSheets[1].Name := '∞≥¿Œ∫∞ µÓ∑œ ¿Ã∑¬_'+E_botyymm2.Text;         //Ω√∆Æ∏Ì ∫Œø©

  //TITLE NAME º≥¡§
  //XL.Range['A1'].value := '';
  //XL.Range['A1'].font.Size := 16;

  //ƒ√∑≥∏Ì ¡ˆ¡§_º≠∫Í≈∏¿Ã∫Ì ¡ˆ¡§
  for i := 1 to OraQuery.Fields.Count do
  begin
       if Notebook1.ActivePage = 'P2' then
            XArr[i]  := OnGrDbGrid2.Columns[i-1].Title.Caption
       else if Notebook1.ActivePage = 'P3' then
            XArr[i]  := OnGrDbGrid3.Columns[i-1].Title.Caption
       else if Notebook1.ActivePage = 'P4' then
            XArr[i]  := OnGrDbGrid4.Columns[i-1].Title.Caption;
  end;

  XL.Range['A1', CHR(64 + OraQuery.Fields.Count)+'1'].Value := XArr;  //Gird √‚∑¬Ω√
  k := 1;
  for i := 1 to OraQuery.Fields.Count do     //Gird √‚∑¬Ω√
  begin
       XL.Range[CHR(64 + i) + '1'].HorizontalAlignment := 3;
       XL.Range[CHR(64 + i) + '1'].Interior.Color:= $00CBF0B3;
       XL.Range[CHR(64 + i) + '1'].font.Size := 9;
       XL.Range[CHR(64 + i) + '1'].font.Bold := True;
  end;

  //∞Àªˆµ» ¿⁄∑·∏¶ excelø° export√≥∏Æ Ω√≈≤¥Ÿ.
  SavePlace := OraQuery.GetBookmark;
  OraQuery.DisableControls;
  OraQuery.First;

  for i := 1 to OraQuery.RecordCount do
  begin
       for j := 1 to OraQuery.Fields.Count do
       begin
            XArr[j]  := OraQuery.Fields[j-1].AsString;
       end;
       
       XL.Range['A' + IntToStr(k+1), CHR(64 + OraQuery.Fields.Count) + IntToStr(k+1)].Value := XArr;
       inc(k);
       OraQuery.Next;
  end;

  //ø©±‚º≠ ∫Œ≈Õ¥¬ EXPORTµ» EXCEL¿⁄∑·∏¶ øπª⁄∞‘ ≤ŸπÃ¥¬ ∫Œ∫–¿‘¥œ¥Ÿ.
  XL.Range['A1', CHR(64 + OraQuery.Fields.Count) + IntToStr(k)].Borders.LineStyle := 1;    //≈◊µŒ∏Æº±¿ª ∏∏µÁ¥Ÿ.  1¿∫ Ω«º±
  XL.Range['A1', CHR(64 + OraQuery.Fields.Count) + IntToStr(k)].Borders.Weight := 2;       //≈◊µŒ∏Æº± µŒ±˙ º≥¡§  2¥¬ ∫∏≈ÎµŒ±˙, 3¿∫ π´¡ˆ µŒ≤®øÚ
  XL.Range['A1', CHR(64 + OraQuery.Fields.Count) + IntToStr(k)].Borders.ColorIndex := 1;   //≈◊µŒ∏Æº± ªˆªÛº≥¡§  1¿∫ ∞À¿∫ªˆ
  XL.Range['A1', CHR(64 + OraQuery.Fields.Count) + IntToStr(k)].font.name := '±º∏≤√º';
  XL.Range['A1', 'A1'].HorizontalAlignment := 3;                                            //∞°øÓµ• ¡§∑ƒ
  XL.Range['A2', CHR(64 + OraQuery.Fields.Count) + IntToStr(k)].font.Size := 9;
  XL.Range['A2', CHR(64 + OraQuery.Fields.Count) + IntToStr(k)].HorizontalAlignment := 1;  //øÏ√¯¡§∑ƒ
  XL.Range['A1', CHR(64 + OraQuery.Fields.Count) + IntToStr(k)].Select;                    //¿⁄∑·∏¶ ∏µŒ SELECT«— »ƒ --«œ¥¬ ¿Ã¿Ø:  AutoFit √≥∏Æ«œ±‚ ¿ß«ÿº≠¿”
  XL.Selection.Columns.AutoFit;                                                             //¿⁄µø¡§∑ƒ
  XL.Range['A2', 'A2'].Select;                                                              //A2ø≠ø° ƒøº≠ ¿ßƒ°Ω√≈¥
  XL.Visible := true;                                                                       //ø¢ºø¿⁄∑· ∫∏ø©¡‹
  Screen.Cursor := crDefault;
  OraQuery.GotoBookmark(SavePlace);
  OraQuery.FreeBookmark(SavePlace);
  OraQuery.EnableControls;
  P_Help.Caption := '√ﬂ√‚ øœ∑·';
end;


procedure TMainForm.E_empnoInitPopup(Sender: TObject);
begin
  Fm_Emp.Edit          := TOnWinPopupEdit(Sender);
  Fm_Emp.E_Search.Text := '';
  Fm_Emp.SqlOpen;
  TOnWinPopupEdit(Sender).PopupControl := Fm_Emp ;
end;

procedure TMainForm.E_empnoCloseUp(Sender: TObject; var Text: String;
  var Accept: Boolean);
begin
  if Fm_Emp.empno <> '' then
  begin
       E_empno.Text             := Fm_Emp.empno + ' - ' + Fm_Emp.Korname;
       E_empno.Hint             := Fm_Emp.empno;
       E_conempno.Text          := Fm_Emp.Eempno + ' - ' + Fm_Emp.EKorname;
       E_conempno.empno         := Fm_Emp.Eempno;
  end;
end;

procedure TMainForm.E_botyymm1Click(Sender: TObject);
begin
  Try
       MonthForm := TMonthForm.Create(Application);
       MonthForm.rDayCaption := TOnMaskEdit(Sender).Text;
       MonthForm.ShowModal;
       TOnMaskEdit(Sender).Text := MonthForm.DayCaption; //Copy(MonthForm.DayCaption,1,4)+ '-'+ Copy(MonthForm.DayCaption,5,2);
  Finally
       MonthForm.Free;
  End;
end;

procedure TMainForm.R_conyn1Click(Sender: TObject);
begin
  if R_Conyn1.Checked then
       BBmail.Enabled := True
  else
       BBmail.Enabled := False;
  open_grid;
end;

procedure TMainForm.BBmailClick(Sender: TObject);
var
     i          : integer;
     SavePlace  : TBookmark;
begin
  P_Help.Caption  := '';

  if OraQuery.RecordCount < 1 then
  begin
       MessageDlg('¡∂»∏µ» πÃ∞·¿Á ≥ªø™¿Ã æ¯Ω¿¥œ¥Ÿ.', MtWarning, [mbok], 0);
       system.Exit;
  end;

  if ( IDYes = Application.MessageBox('¡∂»∏µ» πÃ∞·¿Á ≥ªø™¿« ∞·¿Á±«¿⁄ø°∞‘ ∏ﬁ¿œ¿ª ¿¸º€«œΩ√∞⁄Ω¿¥œ±Ó? ', '»Æ ¿Œ',MB_YESNO ) ) then
  begin
       SavePlace := OraQuery.GetBookmark;
       OraQuery.DisableControls;

       OraQuery.First;

       for i := 1 to OraQuery.RecordCount do
       begin
            //EAI ø¨µø¿ª ≈Î«— Web Hint∑Œ ∏ﬁ¿œ πﬂº€¿ª ¿ß«œø© PZHMAIL ≈◊¿Ã∫Ìø° Insert...2007.08.01   dsa2000
            SendProgID  := 'PKA5010A';
            SendEmpno   := Pempno;
            RcveEmpno   := OraQuery.FieldByName('CONEMPNO').AsString;
            {2017.10.31 jissi ∏ﬁ¿œ≥ªø™¿« ∞Ê∑ŒπÆ±∏ ∫Ø∞Ê
            MailSubject := '[∫Òº≠ºˆ¥Á ∞·¿Á∏¶ ø‰√ªµÂ∏≥¥œ¥Ÿ.]';
            MailBody    := copy(E_botyymm1.Text,1,4)+'≥‚ '+copy(E_botyymm1.Text,5,2)+'ø˘ '+
                           OraQuery.FieldByName('EMPNO').AsString+'-'+OraQuery.FieldByName('KORNAME').AsString+
                           ' ªÁø¯¿« ∫Òº≠ºˆ¥Á ∞·¿Á∏¶ ø‰√ª µÂ∏≥¥œ¥Ÿ.'+#13+#13+#13+
                           '¡æ«’¿ŒªÁΩ√Ω∫≈€ - ¿ŒªÁ/¿Œ∑¬∞≥πﬂ - ±Ÿ≈¬/√ ∞˙±Ÿπ´/»ﬁ∞° - ∫Òº≠ºˆ¥Á µÓ∑œ π◊ ∞·¿Á';
            }
            MailSubject := '[∫Òº≠ºˆ¥Á ∞·¿Á∏¶ ø‰√ªµÂ∏≥¥œ¥Ÿ.]';
            MailBody    := copy(E_botyymm1.Text,1,4)+'≥‚ '+copy(E_botyymm1.Text,5,2)+'ø˘ '+
                           OraQuery.FieldByName('EMPNO').AsString+'-'+OraQuery.FieldByName('KORNAME').AsString+
                           ' ªÁø¯¿« ∫Òº≠ºˆ¥Á ∞·¿Á∏¶ ø‰√ª µÂ∏≥¥œ¥Ÿ.'+#13+#13+#13+
                           '¿ßƒ° : My HR -> ±ﬁø© -> √ ∞˙±Ÿπ´';
            ReceiveYN   := 'N';
            //if ChkReceive.Checked then ReceiveYN := 'Y';

            if not Send_WebHint(SendProgID, SendEmpno, RcveEmpno, MailSubject, MailBody, ReceiveYN) then
            begin
                 MessageDlg('ªÁø¯ '+OraQuery.FieldByName('EMPNO').AsString+'-'+OraQuery.FieldByName('KORNAME').AsString+
                            '¿« ∞·¿Á±«¿⁄ '+RcveEmpno+'-'+OraQuery.FieldByName('CONKORNAME').AsString+
                            'ø°∞‘ ∏ﬁ¿œ ¿¸º€¿Ã Ω«∆– «œø¥Ω¿¥œ¥Ÿ...',mtError, [mbOk], 0);
                 exit;
            end;
            //////////////////////////////////////////////////////////////////////////////
            OraQuery.next;
       end; //end of for

       OraQuery.GotoBookmark(SavePlace);
       OraQuery.FreeBookmark(SavePlace);
       OraQuery.EnableControls;

       MessageDlg('¡¶∏Ò:'+MailSubject+#13+
                  MailBody+#13+
                  'ªÁø¯¿« ∞·¿Á±«¿⁄ø°∞‘ ∏ﬁ¿œ ¿¸º€«œø¥Ω¿¥œ¥Ÿ...',mtInformation,[mbOk], 0);

       P_Help.Caption := '∏ﬁ¿œ¿Ã º∫∞¯¿˚¿∏∑Œ πﬂº€µ«æ˙Ω¿¥œ¥Ÿ';
  end;
end;

//EAI ø¨µø¿ª ≈Î«— Web Hint∑Œ ∏ﬁ¿œ πﬂº€¿ª ¿ß«œø© PZHMAIL ≈◊¿Ã∫Ìø° Insert...2007.08.01
Function TMainForm.Send_WebHint(SendProgID, SendEmpno, RcveEmpno, MailSubject, MailBody, ReceiveYN : String) : Boolean;
begin
  with tmp_oraqry do
  begin
       Close;
       SQL.Clear;
       SQL.Add('insert into PZHMAIL                             ');
       SQL.Add('values (to_char(sysdate,''yyyymmddhh24miss'' ), ');  //SENDTIME   ∏ﬁ¿œπﬂº€ ¿€æ˜Ω√∞£
       SQL.Add('        '''+ SendProgID   +''',                 ');  //SENDPROG   πﬂº€«¡∑Œ±◊∑• ID
       SQL.Add('        '''+ SendEmpno    +''',                 ');  //SEND_PER   πﬂΩ≈¿⁄ ªÁπ¯
       SQL.Add('        '''+ RcveEmpno    +''',                 ');  //RCVR_PER,  ºˆΩ≈¿⁄ ªÁπ¯
       SQL.Add('        ''''                  ,                 ');  //REFR_PER   ∫“« ø‰(¡æ«’¿ŒªÁ)
       SQL.Add('        '''+ MailSubject  +''',                 ');  //SUBJECT    ∏ﬁ¿œ¡¶∏Ò
       SQL.Add('        ''''                  ,                 ');  //HEADER1    ∫“« ø‰(¡æ«’¿ŒªÁ)
       SQL.Add('        '''+ MailBody     +''',                 ');  //BODY1      ∏ﬁ¿œ≥ªøÎ
       SQL.Add('        ''''                  ,                 ');  //TAIL1      ∫“« ø‰(¡æ«’¿ŒªÁ)
       SQL.Add('        '''+ ReceiveYN    +''',                 ');  //RECEIVEYN  'Y' ¿œ∞ÊøÏ ∏ﬁ¿œ ¿–æ˙¿ª∞ÊøÏ º€Ω≈¿⁄ø°∞‘ ºˆΩ≈»Æ¿Œ ∏ﬁ¿œ ∫∏≥ª¡÷±‚
       SQL.Add('        ''N''                 ,                 ');  //EAI_FLAG
       SQL.Add('        ''''                  )                 ');  //EAI_DATE

       try
            ExecSql;
       except
            Result := false;
            exit;
       end; 
       Result := True;
  end;
end;

end.


